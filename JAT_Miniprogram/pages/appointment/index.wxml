<!--appointment/index.wxml-->
<view class="container">
  <!-- 日历选择 -->
  <view class="calendar-section card">
    <view class="section-title">选择日期</view>
    <view class="calendar-header">
      <view class="calendar-nav" bindtap="prevMonth">
        <image src="/static/images/icons/arrow-left.png" class="nav-icon" mode="aspectFit"></image>
      </view>
      <view class="calendar-title">{{year}}年{{month}}月</view>
      <view class="calendar-nav" bindtap="nextMonth">
        <image src="/static/images/icons/arrow-right.png" class="nav-icon" mode="aspectFit"></image>
      </view>
    </view>
    <view class="calendar-weekdays">
      <view class="weekday" wx:for="{{weekdays}}" wx:key="*this">{{item}}</view>
    </view>
    <view class="calendar-days">
      <view class="day-item {{item.month !== month ? 'other-month' : ''}} {{item.date === selectedDate ? 'selected' : ''}} {{item.available ? '' : 'disabled'}}" 
        wx:for="{{days}}" wx:key="date" 
        bindtap="selectDate" data-date="{{item.date}}" data-available="{{item.available}}">
        <view class="day-number">{{item.day}}</view>
        <view class="day-status" wx:if="{{item.month === month}}">
          <text wx:if="{{item.available && item.date !== today}}">可约</text>
          <text class="today" wx:if="{{item.date === today && item.available}}">今天</text>
          <text class="full" wx:if="{{!item.available && item.date >= today}}">已满</text>
        </view>
      </view>
    </view>
  </view>
  
  <!-- 时间段选择 -->
  <view class="time-section card" wx:if="{{selectedDate}}">
    <view class="section-title">选择时间</view>
    <view class="time-slots">
      <view class="time-slot {{item.available ? '' : 'disabled'}} {{selectedTimeSlot === item.id ? 'selected' : ''}}" 
        wx:for="{{timeSlots}}" wx:key="id" 
        bindtap="selectTimeSlot" data-id="{{item.id}}" data-available="{{item.available}}">
        <view class="time-range">{{item.startTime}} - {{item.endTime}}</view>
        <view class="slot-status">
          <text wx:if="{{item.available}}">可约</text>
          <text class="full" wx:else>已满</text>
        </view>
      </view>
    </view>
  </view>
  
  <!-- 服务选择 -->
  <view class="service-section card" wx:if="{{selectedTimeSlot}}">
    <view class="section-title">选择服务</view>
    <view class="service-search">
      <view class="search-input-wrap">
        <icon type="search" size="16" color="#999999"></icon>
        <input class="search-input" placeholder="搜索服务项目" confirm-type="search" bindinput="onSearchInput" bindconfirm="onSearch" value="{{searchKeyword}}"></input>
        <icon wx:if="{{searchKeyword}}" type="clear" size="16" color="#999999" bindtap="clearSearch"></icon>
      </view>
    </view>
    <view class="service-tabs">
      <view class="tab-item {{currentTab === 'all' ? 'active' : ''}}" bindtap="switchTab" data-tab="all">全部</view>
      <view class="tab-item {{currentTab === item.id ? 'active' : ''}}" wx:for="{{categories}}" wx:key="id" bindtap="switchTab" data-tab="{{item.id}}">{{item.name}}</view>
    </view>
    <view class="service-list">
      <view class="service-item {{selectedService === item.id ? 'selected' : ''}}" 
        wx:for="{{services}}" wx:key="id" 
        bindtap="selectService" data-id="{{item.id}}">
        <image class="service-image" src="{{item.imageUrl}}" mode="aspectFill"></image>
        <view class="service-info">
          <view class="service-name">{{item.name}}</view>
          <view class="service-desc ellipsis">{{item.description}}</view>
          <view class="service-price-box">
            <text class="service-price">¥{{item.price}}</text>
            <text class="service-duration">{{item.duration}}分钟</text>
          </view>
        </view>
        <view class="service-check" wx:if="{{selectedService === item.id}}">
          <icon type="success" size="20" color="#3A7734"></icon>
        </view>
      </view>
    </view>
    <view class="empty-state" wx:if="{{services.length === 0}}">
      <image class="empty-icon" src="/static/images/icons/empty.png" mode="aspectFit"></image>
      <text class="empty-text">暂无相关服务</text>
    </view>
  </view>
  
  <!-- 技师选择 -->
  <view class="therapist-section card" wx:if="{{selectedService}}">
    <view class="section-title">选择技师</view>
    <view class="therapist-list">
      <view class="therapist-item {{selectedTherapist === item.id ? 'selected' : ''}}" 
        wx:for="{{therapists}}" wx:key="id" 
        bindtap="selectTherapist" data-id="{{item.id}}">
        <image class="therapist-avatar" src="{{item.avatarUrl}}" mode="aspectFill"></image>
        <view class="therapist-info">
          <view class="therapist-name">{{item.name}}</view>
          <view class="therapist-title">{{item.title}}</view>
          <view class="therapist-rating">
            <view class="star-rating">
              <image wx:for="{{5}}" wx:key="*this" wx:for-index="starIndex" wx:for-item="star" 
                src="/static/images/icons/{{starIndex < item.rating ? 'star-active' : 'star'}}.png" 
                class="star-icon" mode="aspectFit"></image>
            </view>
            <text class="rating-score">{{item.rating}}</text>
            <text class="rating-count">({{item.ratingCount}})</text>
          </view>
          <view class="therapist-tags" wx:if="{{item.tags && item.tags.length > 0}}">
            <text class="tag tag-primary" wx:for="{{item.tags}}" wx:key="*this" wx:for-item="tag">{{tag}}</text>
          </view>
        </view>
        <view class="therapist-check" wx:if="{{selectedTherapist === item.id}}">
          <icon type="success" size="20" color="#3A7734"></icon>
        </view>
      </view>
      <view class="therapist-item random {{selectedTherapist === 'random' ? 'selected' : ''}}" bindtap="selectTherapist" data-id="random">
        <view class="random-avatar">
          <text>随机</text>
        </view>
        <view class="therapist-info">
          <view class="therapist-name">随机分配</view>
          <view class="therapist-desc">系统将为您分配合适的技师</view>
        </view>
        <view class="therapist-check" wx:if="{{selectedTherapist === 'random'}}">
          <icon type="success" size="20" color="#3A7734"></icon>
        </view>
      </view>
    </view>
  </view>
  
  <!-- 底部确认按钮 -->
  <view class="bottom-action-bar safe-bottom">
    <button class="btn btn-primary btn-block" bindtap="confirmAppointment" disabled="{{!canConfirm}}">确认预约</button>
  </view>
</view>
